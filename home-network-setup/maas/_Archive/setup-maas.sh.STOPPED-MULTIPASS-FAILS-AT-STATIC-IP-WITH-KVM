#!/usr/bin/bash

# Goal:
#   Setup Maas, using KVM (rathr than LXD)
# Background
#   Had trouble connecting LXC hosts
#   Prefer KVM since full GUI install

show_msg() {
    MSG="$1"

    echo "================================================================================"
    echo "${MSG}"
    echo "================================================================================"

    read  -n 1 -p "Hit any key" invar

    # Sleep X seconds
    sleep 0.1
}



# Install Maas
#   To understand Linux virtualizatio, read about Qemu, KVM, Libvirt, and so on here:
#   https://ubuntu.com/server/docs/virtualization-qemu
install-maas-via-kvm() {
    show_msg "install-maas-via-kvm"

    cat <<EOF
    # Install Libvirt (KVM and Qemu) and set it up for use by tools like multipass and virt-manager
    #
    # Basic Libvirt
    #   https://ubuntu.com/server/docs/virtualization-libvirt
    # With multipass
    #   https://multipass.run/docs/set-up-the-driver#heading--linux-use-libvirt

EOF

    if groups | grep libvirt; then
        echo "User $USER is in group libvirt. Assuming libvirt is installed"
    else
        echo "User $USER is not in group libvirt. Assuming libvirt is not installed"
        sudo apt update -y
        sudo apt install -y qemu-kvm libvirt-daemon-system
        sudo adduser $USER libvirt

        show_msg "Log out and back in again"
        groups | grep libvirt
    fi

    # Install multipass
    #   https://multipass.run/docs/installing-on-linux
    if ! which multipass; then
        sudo snap install -y multipass
    fi

    # Make sure the multipass socket is accessible by sudo group and this user is in it
    if ! groups | grep sudo; then
        echo "The user should be in the sudo group"
        exit 1
    fi
    F=/var/snap/multipass/common/multipass_socket
    if ! ls -l $F | grep sudo; then
        echo "The file $F should be owned by the group sudo"
        exit 1
    fi

    # connect the libvirt interface/plug
    sudo snap connect multipass:libvirt

    # Make a bridge for this VM so that it can have a static IP - CAN'T... "--network" only works with LXD...
    # https://multipass.run/docs/configure-static-ips


    sudo nmcli connection add type bridge con-name localbr ifname localbr ipv4.method manual ipv4.addresses 192.168.4.1/24
    ip -c -br addr show dev localbr

    # Launch with the instance
    multipass launch --name test1 --network name=localbr,mode=manual,mac="99:00:00:00:00:01"



    # Launch a basic instance
    #   network
    #     https://multipass.run/docs/create-an-instance#heading--create-an-instance-with-multiple-network-interfaces
    #   static IPs
    #     https://multipass.run/docs/configure-static-ips
    multipass launch --name maas-server --cpus 4 --disk 100G --memory 8G --network en0 --network name=maasbridge0

    # Test the multipass instance
    # multipass list
    # Name                    State             IPv4             Image
    # reciprocal-bontebok     Running           192.168.122.38   Ubuntu 22.04 LTS
    multipass info reciprocal-bontebok

    # Show that the instance is in libvirt
    virsh list
    #  Id   Name                  State
    # -------------------------------------
    # 1    reciprocal-bontebok   running


    multipass delete reciprocal-bontebok
    # multipass purge # remove all deleted instances


    # https://releases.ubuntu.com/jammy/
    # Supports PXE and all other modes of installation, per
    #   http://archive.ubuntu.com/ubuntu/dists/jammy/main/installer-amd64/20101020ubuntu629/legacy-images/
    wget https://releases.ubuntu.com/jammy/ubuntu-22.04.2-live-server-amd64.iso

    # Start a KVM instance via virsh (libvirt native)
    # virsh start maas-server
    #
    # Use maas to create an instant


    # A Gui for libvirt
    # sudo apt install virt-manager


    if which maas >/dev/null; then
	echo "Command 'maas' is in PATH. Assuming it is installed properly."
    else
	#Installing Maas per https://maas.io/docs/how-to-do-a-fresh-install-of-maas
	#via <3.3 packages> (as opposed to snap)
	sudo apt-add-repository ppa:maas/3.3-next
	sudo apt update -y
	sudo apt-get -y install maas -y
    fi
}


check-status() {
    show_msg "check-status"

    # systemctl status --no-pager | grep '.service' | grep maas
    for i in maas-regiond maas-syslog maas-proxy maas-http maas-rackd; do
	echo $i
	 systemctl status $i --no-pager
    done

    show_msg "check-status: done"
}

setup-admin() {
    show_msg "setup-admin"

    if sudo maas apikey --username maasadmin >/dev/null; then
	echo "Maas admin user exists"
    else
	cat <<EOF
	 Params I use for maas admin user:
	 - name: maasadmin
	 - pw: password (for testing)
	 - email: unused@email.com (since it is not used)
	 - gh:<github user> (since that is my github user and the local SSH key gives access to it)
EOF

	echo "Testing your SSH credentials to Github..."
	if ssh -T git@github.com 2>&1  | grep 'success'; then
	    echo "The user shown above has access to github, you can use 'gh:<github user>' in Maas"
	else
	    echo "Warning, this OS account is not set up to acccess github via SSH"
	fi

	sudo maas createadmin
    fi

    IP=$(hostname -i)
    xdg-open http://${IP}:5240/MAAS &>/dev/null
}

setup-networks() {
    show_msg "setup-networks"

    cat <<EOF
    # https://maas.io/docs/how-to-connect-maas-networks
    The default network, 'fabric0' should be created from the local subnet
EOF

    show_msg "setup-networks: done"

}

setup-dhcp() {
    show_msg "setup-dhcp"

    # https://maas.io/docs/how-to-enable-dhcp
    cat <<EOF
    Choose the default VLAN. Click on Maas -> subnets -> untagged
    My setup:
    Subnet: 192.168.8.0/24
    Mangement:
      - by default, the subnet is managed (i.e. Maas will provide DHCP)
      - To change the management of a subnet, see:
        - https://discourse.maas.io/t/subnet-management-deb-3-0-cli-test/4716#heading--controlling-subnet-management
    IP Range: 192.168.8.191 - 192.168.8.254 (using static IPs in low range, for the Maas server itself)

    Review:
      - https://discourse.maas.io/t/how-to-manage-ip-ranges/5136
      - https://discourse.maas.io/t/maas-glossary/5416#heading--ip-ranges
      - https://discourse.maas.io/t/subnet-management-deb-3-0-cli-test/4716
      - https://discourse.maas.io/t/subnet-management-deb-3-0-cli-test/4716#heading--controlling-subnet-management
EOF

    show_msg "setup-dhcp: done"
}

test-dhcp() {
    show_msg "test-dhcp"

    if ! which dhcpcd >/dev/null; then
        sudo apt install dhcpcd5
    fi
    F=/tmp/dhcpcd.out
    sudo dhcpcd -T enp8s0 -t 2 &> $F # Specify expected NIC name
    echo "Scanning results of DHCP test at $F"
    echo "Look at the file via: cat $F"
    if cat $F | grep 'new_filename' | grep 'lpxelinux.0' >/dev/null; then
	echo "Looks good"
    fi

    show_msg "test-dhcp: done"
}

setup-lxd-servers() {
    show_msg "setup-lxd-servers - NOT ON MAAS SERVER (IF IT WAS INSTALLED OUTSIDE LXD) - Directions only..."

    cat <<EOF
    Run this on each  machine providing the LXC virtualization service
    https://maas.io/docs/how-to-set-up-lxd

    # Install LXD from SNAP, not OS Packages
    #
    #sudo apt-get purge -y *lxd* *lxc*
    #sudo apt-get autoremove -y
    sudo snap install lxd
    sudo snap refresh

    # Initialize LXD
    # https://maas.io/docs/how-to-set-up-lxd#heading--lxd-init
    # Options for 'lxd init':
    # - no clustering
    # - create default storage pool of type 'dir'
    # - NO, do not connect to Maas server now (we need to turn off DHCP etc first)
    # - YES, make the lxc server available over the network
    sudo lxd init

    # Make sure LXD is not providing DHCP
    #
    lxc network set lxdbr0 dns.mode=none
    lxc network set lxdbr0 ipv4.dhcp=false
    lxc network set lxdbr0 ipv6.dhcp=false
    lxc network show lxdbr0

EOF

    show_msg "setup-lxd-servers: done"
}

check-dhcp-and-dns-in-lxc-server() {
    show_msg "Check that DHCP is off for the LXC server"

    cat <<EOF
    # Run these blocks in the LXC server

    if lxc network show lxdbr0 | grep 'dhcp' | grep 'false' | wc -l | grep 2 >/dev/null; then
	echo "DHCP is not running in LXC"
    else
	show_msg "ERROR: DHCP might be running in LXC"
    fi

    if lxc network show lxdbr0 | grep 'dns' | grep 'none' | wc -l | grep 1 >/dev/null; then
	echo "DNS is not running in LXC"
    else
	show_msg "ERROR: DNS might be running in LXC"
    fi
EOF

    show_msg "Check that DHCP is off for the LXC server: done"

}

provision-vms-in-maas() {
    show_msg "provision-vms-in-maas"

    cat <<EOF
    # Add LXC "hosts/servers"
    # READ THIS
    #   https://maas.io/docs/how-to-manage-vm-hosts#heading--adding-a-vm-host
    # KEY POINT
    #   Add the LXD bridge gateway address
    #  "Enter the LXD address as the gateway address of the bridge for that LXD instance. For example, if lxdbr0 has address 10.4.241.0, the default gateway address is 10.4.241.1."
    # See:
    #   - lxc network show lxdbr0
    #   - ip a s dev lxdbr0 | grep 'inet ' | awk '{print $2}' | cut -d '/' -f 1


    ################################################################################
    # After the Machine/VM is created/compposed it will go to "Commissioning" state
    # In a minute or wo, it will turn off and go to the "Ready" state
    # At this point, the machine can be "Deployed"
    ################################################################################

    # To Deploy a machine
    # Maas -> Machines -> Select VM(s) -> Take Action -> Deploy

    # The LXC Servers/Hosts will appear as Machines, with a power state of "unknown"
    # These should not be provisioned, so make a pool for them
    # Put the LXC hosts in the other pool
    # Maas -> Machines -> <LXC host> -> Configuration -> Machine/Edit


    # The linux user name varies, depending on the OS/Image
    Log in via: ssh ubuntu@<IP=192.168.8.202>

    # Read up on Maas projects
    # https://maas.io/docs/how-to-set-up-lxd#heading--projects-tutorial
EOF

    show_msg "provision-vms-in-maas: done"
}

purge_lxd_snap() {
    echo "Remove VMs"
    V=$(lxc list | grep 'VIRTUAL' | cut -d' ' -f 2 | tr '\n' ' ')
    echo "VMs: ${V}"
    for i in $V; do
        lxc delete $i --force
    done
    lxc list
    show_msg "VMs should be gone now"

    echo "Remove images"
    # TODO
    lxc image list
    show_msg "Images should be gone now"

    echo "Remove networks"
    if lxc network list | egrep 'YES' | wc -l | grep 0; then
	echo "no networks"
    else
	lxc network detach-profile lxdbr0 default
	lxc network delete lxdbr0
    fi
    #N=$(lxc network list | egrep 'YES' | cut -d' ' -f 2 | tr '\n' ' ')
    #for i in $V; do
    #    lxc network delete $i --force-local
    #done
    lxc network list
    show_msg "MANAGED networks should be gone now"

    echo "Remove volumes"
    V=$(lxc storage volume list default | egrep 'maas' | cut -d' ' -f 4 | tr '\n' ' ')
    for i in $V; do
        lxc storage volume delete default $i #--force-local
    done
    # lxc storage delete default # Fails, lying that this is in use
    # lxd sql global "SELECT * FROM storage_volumes;"
    show_msg "Volumes should be gone"

    echo "Remove lxd snap"
    #sudo snap remove lxd
    sudo snap remove --purge lxd # Needed for one box... Maybe this is all that is needed?
}

################################################################################
# Call this to set up MaaS Server
################################################################################
setup_maas_server() {

    install-maas-via-kvm

    check-status

    setup-admin

    setup-networks

    setup-dhcp

    test-dhcp
}

################################################################################
# Steps to set up an LXD host to provide VMs for use by Maas
################################################################################
setup_maas_lxd_hosts() {
    setup-lxd-servers
    check-dhcp-and-dns-in-lxc-server
    provision-vms-in-maas
}


setup_maas_server
