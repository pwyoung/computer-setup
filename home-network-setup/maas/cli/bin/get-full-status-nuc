#!/bin/bash

# TODO: ansible
# https://cloudinit.readthedocs.io/en/latest/reference/examples.html#configure-instance-to-be-managed-by-ansible

################################################################################

# Dir containing this script
SCRIPT_DIR=$(dirname $(realpath "$0}"))

# Cloud-Init Script
MC="${SCRIPT_DIR}/../cloud-init/ansible"

# MAAS server
H='192.168.3.6'
MS="http://${H}:5240/MAAS"

# MAAS user
#MU='maasadmin'
MU='pwyoung'

# MAAS API KEY
#  mkdir ~/.maas-api-keyfiles
#  # Assuming passwordless sudo
#  ssh maas-server "sudo maas apikey --username=$MU" > ~/.maas-api-keyfiles/$MU
MK=$(head -1 ~/.maas-api-keyfiles/$MU)

# REQUIRED PARAMATERS
ARCH="amd64"
# Machine's netboot MAC
MAC='48:21:0b:55:b4:5b'
# Power type
PT="manual"

# Hostname
HN='nuc'
# Domain Name
DN='maas'
# Description
DESC="New machine: $HN $DN"

# Command output
OF=~/.maas-command-output.txt

# Temp file for running a maas cli command
MCF=~/.maas-machines-read.json

################################################################################

login() {
    if maas list | egrep "^${MU} " >/dev/null; then
        echo "User $MU is already logged in"
    else
        echo "Logging in, user=$MU"
        maas login $MU $MS $MK | tee -a $OF
    fi
}

get_status() {
   

    cat $MCF | jq -r ".[] | select(.hostname == \"${HN}\")" | jq '[.status, .status_name, .network_test_status_name, .storage_test_status_name, .memory_test_status, .status_action] | @csv' | tr -d '"\\' 
    # 1,Commissioning,Unknown,Pending,-1,
}


run() {
    login

    get_status
}

run









